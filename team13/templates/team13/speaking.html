<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>آزمون Speaking</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/static/team13/styles/style.css">
</head>

<body class="dark-mode">
<header class="main-header">
  <div class="header-right">
    <div class="header-icon" title="خانه"
     onclick="window.location.href='/team13/'">🏠</div>
    <div class="header-icon" id="themeBtn" title="تغییر تم">☀️</div>
  </div>

  <h2 class="header-title">نام محصول</h2>

  <div class="header-back" onclick="window.location.href='/team13/'">❯</div>
</header>

<main class="container">
  <div class="card">

    <div class="card-content">
      <h3>آزمون گفتاری</h3>
      <h1>SPEAKING EXAM</h1>
      <p class="description-text">
        در این آزمون، مهارت گفتاری شما از نظر روانی صحبت، تلفظ، دامنه واژگان و دقت گرامری ارزیابی می‌شود.
        کافیست پاسخ را با صدای خودتان ضبط کنید و ارسال کنید تا نتیجه دریافت شود.
      </p>
      <button class="btn-start" id="startBtn" type="button">شروع آزمون</button>
    </div>

    <div class="card-image">
      <img src="../../static/team13/public/images/speaking_exam_image.png" alt="آزمون اسپیکینگ">
    </div>

  </div>
</main>

<script src="/static/team13/scripts/app.js"></script>

<script>
  const startBtn = document.getElementById("startBtn");

  const headerBtns = [
    document.querySelector('.header-right .header-icon'),
    document.getElementById('themeBtn'),
    document.querySelector('.header-back')
  ].filter(Boolean);

  let startErrorTimer = null;
  let startShowingError = false;

  function setFrozen(isFrozen){
    headerBtns.forEach(el => el.classList.toggle("ui-disabled", isFrozen));
    startBtn.disabled = isFrozen;
    startBtn.classList.toggle("loading", isFrozen);
  }

  function pageExitThenGo(url){
    document.body.classList.remove("page-enter");
    document.body.classList.add("page-exit");
    setTimeout(() => (window.location.href = url), 160);
  }

  function resetStartBtn(){
    clearTimeout(startErrorTimer);
    startErrorTimer = null;
    startShowingError = false;

    startBtn.classList.remove("error", "recover");
    startBtn.textContent = "شروع آزمون";
  }

  // todo: delete mocks
  const MOCK_API = true;
  const MOCK_DELAY = 1500;
  const MOCK_FAIL = false;

  async function fetchQuestion(){
    if (MOCK_API){
      await new Promise(r => setTimeout(r, MOCK_DELAY));
      if (MOCK_FAIL) throw new Error("سرور در دسترس نیست (تست)");

      return {
        question_id: 1,
        title: "Talk about a memorable trip you have had.",
        source: "Mock Source - Speaking",
        prompt: "Speak for 1-2 minutes."
      };
    }

    const res = await fetch("/team13/speaking/question");
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data.message || "خطا در دریافت سوال");
    return data;
  }

  startBtn.addEventListener("click", async () => {
    if (startShowingError) resetStartBtn();

    setFrozen(true);

    // (اختیاری) فقط اگر طول کشید، متن لودینگ را نشان بده
    const loadingTimer = setTimeout(() => {
      startBtn.textContent = "در حال دریافت سوال...";
    }, 150);

    try {
      const q = await fetchQuestion();
      clearTimeout(loadingTimer);

      // کلید جدا برای اسپیکینگ
      sessionStorage.setItem("speaking_question", JSON.stringify(q));
      pageExitThenGo("exam/");

    } catch (e) {
      clearTimeout(loadingTimer);

      startShowingError = true;
      startBtn.textContent = e.message || "خطا";
      requestAnimationFrame(() => startBtn.classList.add("error"));

      // برگشت نرم به حالت عادی بعد ۵ ثانیه
      startErrorTimer = setTimeout(() => {
        startBtn.classList.remove("error");
        startBtn.classList.add("recover");
        startBtn.textContent = "شروع آزمون";

        setTimeout(() => {
          startBtn.classList.remove("recover");
          startShowingError = false;
        }, 260);
      }, 5000);

    } finally {
      setFrozen(false);
    }
  });
</script>

</body>
</html>
