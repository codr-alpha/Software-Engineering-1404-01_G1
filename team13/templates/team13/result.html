<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù†ØªÛŒØ¬Ù‡ Ø¢Ø²Ù…ÙˆÙ†</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/static/team13/styles/style.css">
</head>

<body class="dark-mode page-enter">
<header class="main-header">
  <div class="header-right">
    <div class="header-icon" title="Ø®Ø§Ù†Ù‡" onclick="window.location.href='/team13/'">ğŸ </div>
    <button class="header-icon" id="themeBtn" type="button" title="ØªØºÛŒÛŒØ± ØªÙ…">â˜€ï¸</button>
  </div>

  <h2 class="header-title">Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„</h2>

  <!-- Ø¨Ø¯ÙˆÙ† Ø¯Ú©Ù…Ù‡ Ø¨Ú© -->
  <div style="width:45px;height:45px;"></div>
</header>

<main class="container">

  <div class="card result-card">
    <section class="result-grid">
      <!-- Left: vertical image (like writing intro) -->
      <aside class="result-left" aria-label="Ø¹Ú©Ø³ Ù†ØªÛŒØ¬Ù‡">
        <div class="result-image-box">
          <img id="resultImage" class="result-image" alt="result image">
        </div>
      </aside>

      <!-- Center: time + subscores + back -->
      <section class="result-center" aria-label="Ø¬Ø²Ø¦ÛŒØ§Øª Ù†ØªÛŒØ¬Ù‡">
        <div class="result-center-block">
          <div class="detail-line">
            <div class="detail-label">Ø²Ù…Ø§Ù† Ú©Ù„ÛŒ:</div>
            <div class="detail-value" id="overallTime">00:00</div>
          </div>

          <div class="detail-block">
            <div class="detail-title">Ù†Ù…Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø²Ø¦ÛŒ:</div>
            <ul class="subscores" id="subScores"></ul>
          </div>
        </div>

        <div class="result-actions">
          <button class="btn-start btn-choice" id="backToExamsBtn" type="button">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</button>
        </div>
      </section>

      <!-- Right: score on top, chart below -->
      <aside class="result-right" aria-label="Ù†Ù…Ø±Ù‡ Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø±">
        <div class="result-scorebox">
          <div class="score-big">
            <span class="score-denom">30/</span>
            <span id="scoreValue">0</span>
          </div>
        </div>

        <div class="result-chartbox">
          <div class="result-chart-title">Ù†Ù…ÙˆØ¯Ø§Ø± Ù¾ÛŒØ´Ø±ÙØª</div>
          <div class="result-chart-body">
            <div class="tile-muted">Ø¨Ù‡â€ŒØ²ÙˆØ¯ÛŒâ€¦</div>
          </div>
        </div>
      </aside>
    </section>
  </div>

</main>

<script src="/static/team13/scripts/app.js"></script>
<script>
  // ----- helpers -----
  function formatMMSS(totalSeconds){
    totalSeconds = Math.max(0, Number(totalSeconds) || 0);
    const m = String(Math.floor(totalSeconds / 60)).padStart(2, "0");
    const s = String(totalSeconds % 60).padStart(2, "0");
    return `${m}:${s}`;
  }

  function setBadge(score){
    const badge = document.getElementById("scoreBadge");
    const emoji = document.getElementById("badgeEmoji");
    const text  = document.getElementById("badgeText");
    const imgEmoji = document.getElementById("tileEmoji");

    let level = "mid";
    if (score >= 24) level = "good";
    else if (score >= 16) level = "mid";
    else level = "low";

    badge.classList.remove("good","mid","low");
    badge.classList.add(level);

    if (level === "good"){
      emoji.textContent = "ğŸ˜„";
      text.textContent = "Ø¹Ø§Ù„ÛŒ";
      imgEmoji.textContent = "ğŸ†";
    } else if (level === "mid"){
      emoji.textContent = "ğŸ™‚";
      text.textContent = "Ù…ØªÙˆØ³Ø·";
      imgEmoji.textContent = "ğŸ‘";
    } else {
      emoji.textContent = "ğŸ˜•";
      text.textContent = "Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ…Ø±ÛŒÙ†";
      imgEmoji.textContent = "ğŸ“˜";
    }
  }

  function renderSubscores(qType, scores){
    const ul = document.getElementById("subScores");
    ul.innerHTML = "";

    const maps = {
      writing: [
        ["task_achievement","Task Achievement"],
        ["coherence","Coherence"],
        ["vocabulary","Vocabulary"],
        ["grammar","Grammar"],
        ["mechanics","Mechanics"],
      ],
      speaking: [
        ["delivery","Delivery"],
        ["language_use","Language Use"],
        ["topic_development","Topic Development"],
      ],
    };

    const items = (maps[qType] || []).filter(([k]) => scores && scores[k] !== undefined && scores[k] !== null);

    if (!items.length){
      const li = document.createElement("li");
      li.textContent = "Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.";
      ul.appendChild(li);
      return;
    }

    items.forEach(([key,label]) => {
      const li = document.createElement("li");
      li.innerHTML = `<span class="sub-label">${label}</span><span class="sub-val">${scores[key]}</span>`;
      ul.appendChild(li);
    });
  }

  // ----- init -----
  const raw = sessionStorage.getItem("team13_last_result");
  const qType = sessionStorage.getItem("team13_question_type") || "writing";
  const tSec = sessionStorage.getItem("team13_overall_time_seconds");

  let data = {};
  try{ data = raw ? JSON.parse(raw) : {}; }catch(e){ data = {}; }

  const score = Number(data.score ?? 0);

  document.getElementById("scoreValue").textContent = String(score);
  document.getElementById("overallTime").textContent = formatMMSS(tSec);

  setBadge(score);
  renderSubscores(qType, data.category_scores || {});

  document.getElementById("backToExamsBtn").addEventListener("click", () => {
    // Ø§Ú¯Ø± Ù†ÙˆØ¹ Ø³ÙˆØ§Ù„ Ø±Ùˆ Ø¯Ø§Ø±ÛŒÙ…ØŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ ØµÙØ­Ù‡ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ Ø¨Ø±Ú¯Ø±Ø¯ÛŒÙ…
    const url = qType === "speaking" ? "/team13/speaking/" : "/team13/writing/";
    document.body.classList.remove("page-enter");
    document.body.classList.add("page-exit");
    setTimeout(() => (window.location.href = url), 160);
  });

  const resultImg = document.getElementById("resultImage");

  let imageName = "result_bad.png";
  if (score >= 24) imageName = "result_good.png";
  else if (score >= 16) imageName = "result_mid.png";

  resultImg.src = `/static/team13/public/images/${imageName}`;


</script>
</body>
</html>
