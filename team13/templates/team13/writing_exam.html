<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØµÙØ­Ù‡ Ø¢Ø²Ù…ÙˆÙ† Writing</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/static/team13/styles/style.css">

</head>

<body class="dark-mode">

  <header class="main-header">
  <div class="header-right">
    <div class="header-icon" title="Ø®Ø§Ù†Ù‡"
     onclick="window.location.href='/team13/'">ğŸ </div>
    <div class="header-icon" id="themeBtn" title="ØªØºÛŒÛŒØ± ØªÙ…">â˜€ï¸</div>
  </div>

  <h2 class="header-title">
    Ø¢Ø²Ù…ÙˆÙ† WRITING - Ø²Ù…Ø§Ù† Ø³Ù¾Ø±ÛŒâ€ŒØ´Ø¯Ù‡: <span id="timer">00:00</span>
  </h2>

  <button class="header-back header-exit" type="button"
          onclick="window.location.href='/team13/writing/'">Ø®Ø±ÙˆØ¬</button>
  </header>

  <main class="container">
    <div class="card exam-card">

      <!-- Question Box -->
      <section class="exam-question">
        <h2 class="exam-question-title" id="qTitle">Ù…ØªÙ† Ø³ÙˆØ§Ù„</h2>
        <p class="exam-question-text" id="qText"></p>
        <p class="exam-question-source" id="qSource">Ù…Ù†Ø¨Ø¹ Ø¢Ø²Ù…ÙˆÙ†</p>
      </section>

      <!-- Answer Area -->
      <section class="exam-bottom">
        <textarea id="answerBox" class="exam-textarea" placeholder="Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>

        <div class="exam-actions">
          <button id="reportBtn" class="exam-action-btn" type="button">Ú¯Ø²Ø§Ø±Ø´</button>
          <button id="submitBtn" class="exam-action-btn primary" type="button">Ø«Ø¨Øª Ù¾Ø§Ø³Ø®</button>
        </div>
      </section>

    </div>
  </main>

  {# TODO: change to <scripts src="{% static 'team13/scripts/app.js' %}"></scripts> #}
  <script src="/static/team13/scripts/app.js"></script>

  <script>
    // ØªØ§ÛŒÙ…Ø± Ø³Ø§Ø¯Ù‡ (Ù†Ù…ÙˆÙ†Ù‡)
    let seconds = 0;
    const timerEl = document.getElementById("timer");

    function tick() {
      seconds++;
      const m = String(Math.floor(seconds / 60)).padStart(2, "0");
      const s = String(seconds % 60).padStart(2, "0");
      timerEl.textContent = `${m}:${s}`;
    }
    setInterval(tick, 1000);
  </script>

  <script>
    const submitBtn = document.getElementById("submitBtn");
    const reportBtn = document.getElementById("reportBtn");
    const answerBox = document.getElementById("answerBox");

    const qTitle = document.getElementById("qTitle");
    const qText = document.getElementById("qText");
    const qSource = document.getElementById("qSource");

    const homeBtn = document.querySelector('.header-right .header-icon[title="Ø®Ø§Ù†Ù‡"]'); // ğŸ 
    const exitBtn = document.querySelector('.header-back.header-exit');    // Ø®Ø±ÙˆØ¬

    let errorResetTimer = null;
    let isShowingError = false;
    let isWaiting = false;
    let questionId = null;

    // --- helpers ---
    function getCookie(name){
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : "";
}

    function setWaiting(waiting){
      isWaiting = waiting;

      [homeBtn].forEach(el => el && el.classList.toggle("ui-disabled", waiting));

      if (exitBtn){
        exitBtn.disabled = waiting;
        exitBtn.classList.toggle("ui-disabled", waiting);
      }

      if (answerBox) answerBox.disabled = waiting;
      if (reportBtn) reportBtn.disabled = waiting;

      reportBtn.classList.toggle("ui-disabled", waiting);
      submitBtn.classList.toggle("loading", waiting);
    }

    function resetSubmitButton(){
      clearTimeout(errorResetTimer);
      errorResetTimer = null;
      isShowingError = false;

      submitBtn.classList.remove("error");
      submitBtn.textContent = "Ø«Ø¨Øª Ù¾Ø§Ø³Ø®";
    }

    function showSubmitError(message){
      isShowingError = true;
      submitBtn.classList.add("error");
      submitBtn.textContent = message || "Ø®Ø·Ø§";

      clearTimeout(errorResetTimer);
      errorResetTimer = setTimeout(() => {
        resetSubmitButton();
      }, 5000);
    }

    async function apiGetQuestion(){
      setWaiting(true);
      submitBtn.disabled = true;

      try{
        const res = await fetch("/team13/get_question/?type=writing", { method: "GET", credentials: "same-origin", headers: { "Accept": "application/json" } });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³ÙˆØ§Ù„");

        questionId = data.id;
        sessionStorage.setItem("team13_question_id", String(questionId));
        sessionStorage.setItem("team13_question_type", "writing");

        if (qTitle) qTitle.textContent = data.title || "Ù…ØªÙ† Ø³ÙˆØ§Ù„";
        if (qText) qText.textContent = data.text || "";
        if (qSource) qSource.textContent = `Ø³ÙˆØ§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡ Ø§Ø²:  ${data.id}`;

      } finally{
        submitBtn.disabled = false;
        setWaiting(false);
      }
    }

    async function apiSubmitWriting(answerText){
      if (!questionId){
        const sid = sessionStorage.getItem("team13_question_id");
        if (sid) questionId = Number(sid);
  }
      if (!questionId) throw new Error("Ø³ÙˆØ§Ù„ Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª");

      const csrf = getCookie("csrftoken");

      const res = await fetch("/team13/submit_response/", {
        method: "POST",
        credentials: "same-origin",
            headers: {
              "Content-Type": "application/json",
              ...(csrf ? { "X-CSRFToken": csrf } : {}),
            },
            body: JSON.stringify({
              question_id: questionId,
              response: answerText
            })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || "Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø§Ø³Ø®");
      return data; // {grade_id, score, category_scores, feedback}
}

    window.addEventListener("DOMContentLoaded", () => {
      apiGetQuestion().catch(err => showSubmitError(err.message || "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³ÙˆØ§Ù„"));
    });

    submitBtn.addEventListener("click", async () => {
      if (isWaiting) return;

      // Ø§Ú¯Ø± Ø§Ù„Ø§Ù† Ø§Ø±ÙˆØ± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒØ´Ù‡:
      // Ø¨Ø§ Ù‡Ù…ÛŒÙ† Ú©Ù„ÛŒÚ© Ø±ÛŒØ³ØªØ´ Ú©Ù† Ùˆ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡ (ÛŒØ¹Ù†ÛŒ Ù‡Ù…ÛŒÙ† Ú©Ù„ÛŒÚ© Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯ Ø¨ÙØ±Ø³ØªÙ‡)
      if (isShowingError) resetSubmitButton();

      const text = (answerBox.value || "").trim();
      if (!text){
        showSubmitError("Ù¾Ø§Ø³Ø® Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
        return;
      }

      submitBtn.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...";
      setWaiting(true);

      try {
        const result = await apiSubmitWriting(text);

        sessionStorage.setItem("team13_last_result", JSON.stringify(result));
        sessionStorage.setItem("team13_overall_time_seconds", String(seconds));
        // Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ ØµÙØ­Ù‡ Ù†ØªÛŒØ¬Ù‡
        document.body.classList.remove("page-enter");
        document.body.classList.add("page-exit");
        setTimeout(() => (window.location.href = "/team13/result/"), 160);
        return;

        submitBtn.textContent = "Ø«Ø¨Øª Ø´Ø¯!";
        setTimeout(() => { submitBtn.textContent = "Ø«Ø¨Øª Ù¾Ø§Ø³Ø®"; }, 900);

      } catch (err) {
        showSubmitError(err.message || "Ø®Ø·Ø§");
      } finally {
        setWaiting(false);
      }
    });
  </script>


</body>
</html>
