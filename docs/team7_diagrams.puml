@startuml Writing_Sequence_Diagram
title Writing Evaluation - Sequence Diagram (Team 7)

actor Student
participant "Browser/\nJavaScript" as JS
participant "Django\nView\n(views.py)" as View
participant "Evaluation\nService\n(services.py)" as Service
participant "Writing\nEvaluator" as Evaluator
participant "OpenAI\nLLM API" as LLM
database "PostgreSQL\n(team7 DB)" as DB

Student -> JS: Submit essay text
activate JS

JS -> JS: Validate minimum\nword count (50 words)

alt Validation fails
    JS -> Student: Show error message
else Validation passes
    JS -> JS: Get user_id from\nAuthManager
    JS -> View: POST /team7/api/submit-writing/\n{user_id, question_id, text}
    activate View
    
    View -> View: Parse JSON request
    View -> View: Validate required fields
    
    View -> Service: evaluate_writing(user_id,\nquestion_id, text)
    activate Service
    
    Service -> DB: Query Question by question_id
    activate DB
    DB --> Service: Question object
    deactivate DB
    
    alt Question not found
        Service --> View: {error: "QUESTION_NOT_FOUND"}, 404
        View --> JS: JSON error response
        JS -> Student: Show error message
    else Question found
        Service -> Evaluator: validate_length(text)
        activate Evaluator
        
        Evaluator -> Evaluator: Count words\nCheck 50-150 range
        
        alt Invalid length
            Evaluator --> Service: (False, error_message)
            Service --> View: {error: "INVALID_INPUT"}, 400
            View --> JS: JSON error response
            JS -> Student: Show error message
        else Valid length
            Evaluator --> Service: (True, "OK")
            
            Service -> Evaluator: analyze(text, question, mode)
            
            Evaluator -> LLM: POST chat.completions.create\n{model, messages, temperature}
            activate LLM
            note right of LLM
                Prompt includes:
                - ETS rubric criteria
                - Question details
                - Student essay
            end note
            
            LLM -> LLM: Analyze essay\nScore on 0-5 scale
            LLM --> Evaluator: JSON response with\nscores and feedback
            deactivate LLM
            
            alt LLM fails
                Evaluator --> Service: None
                Service --> View: {error: "SERVICE_UNAVAILABLE"}, 503
                View --> JS: JSON error response
                JS -> Student: Show service unavailable
            else LLM success
                Evaluator -> Evaluator: Parse JSON response
                Evaluator --> Service: {overall_score, feedback, criteria}
                
                Service -> DB: Create Evaluation record\n(user_id, question, score, feedback)
                activate DB
                DB --> Service: Evaluation object
                deactivate DB
                
                Service -> DB: Create DetailedScore records\n(Grammar, Vocabulary, etc.)
                activate DB
                DB --> Service: DetailedScore objects
                deactivate DB
                
                Service --> View: {status: "success",\nevaluation_id, score, feedback, criteria}, 200
                deactivate Evaluator
                deactivate Service
                
                View --> JS: JSON success response
                deactivate View
                
                JS -> JS: Calculate average score\nPrepare result data
                JS -> Student: Display results popup\nwith score and feedback
            end
        end
    end
end

deactivate JS

@enduml

@startuml Writing_Activity_Diagram
title Writing Evaluation - Activity Diagram (Team 7)

|Student|
start
:Enter essay text\nin answer textarea;

|JavaScript|
:Save answer to examState;
:Validate all answers;

if (Word count >= 50?) then (no)
  :Show error:\n"حداقل 50 کلمه پاسخ دهید";
  stop
else (yes)
  :Show submit confirmation popup;
  
  if (User confirms?) then (no)
    stop
  else (yes)
    :Stop timers;
    :Show loading popup\n"درحال ارزیابی...";
    :Get user_id from AuthManager;
    
    |Django View|
    :Receive POST request\n/api/submit-writing/;
    :Parse JSON body;
    
    if (Required fields present?) then (no)
      :Return 400\nINVALID_INPUT;
      |JavaScript|
      :Close popup;
      :Show error alert;
      stop
    else (yes)
      |EvaluationService|
      :Query Question from DB;
      
      if (Question exists?) then (no)
        :Return 404\nQUESTION_NOT_FOUND;
        |JavaScript|
        :Close popup;
        :Show error alert;
        stop
      else (yes)
        |WritingEvaluator|
        :Count words in text;
        
        if (50 <= words <= 150?) then (no)
          :Return validation error;
          |JavaScript|
          :Close popup;
          :Show error alert;
          stop
        else (yes)
          :Build system prompt\nwith ETS rubric;
          :Build user prompt\nwith question + essay;
          :Call OpenAI API\nchat.completions.create();
          
          if (API call successful?) then (no)
            :Return 503\nSERVICE_UNAVAILABLE;
            |JavaScript|
            :Close popup;
            :Show error alert;
            stop
          else (yes)
            :Parse JSON response;
            :Extract score, feedback, criteria;
            
            |EvaluationService|
            :Create Evaluation record;
            :Create DetailedScore records\nfor each criterion;
            :Return success response\nwith evaluation details;
            
            |JavaScript|
            :Close loading popup;
            :Calculate average score;
            :Show result popup with:\n- Overall score\n- Feedback\n- Criteria scores;
            stop
          endif
        endif
      endif
    endif
  endif
endif

@enduml

@startuml Speaking_Sequence_Diagram
title Speaking Evaluation - Sequence Diagram (Team 7)

actor Student
participant "Browser/\nJavaScript" as JS
participant "Django\nView\n(views.py)" as View
participant "Evaluation\nService\n(services.py)" as Service
participant "Speaking\nEvaluator" as Evaluator
participant "OpenAI\nWhisper API\n(ASR)" as Whisper
participant "OpenAI\nLLM API" as LLM
participant "File\nStorage" as Storage
database "PostgreSQL\n(team7 DB)" as DB

Student -> JS: Record audio\nusing MediaRecorder
activate JS

JS -> JS: Stop recording\nCreate audio blob

JS -> JS: Validate audio\nduration (30-90 sec)

alt Validation fails
    JS -> Student: Show error message
else Validation passes
    JS -> JS: Get user_id from\nAuthManager
    JS -> JS: Create FormData with:\n- user_id\n- question_id\n- audio_file
    
    JS -> View: POST /team7/api/submit-speaking/\n(multipart/form-data)
    activate View
    
    View -> View: Extract POST data\nand FILES
    View -> View: Validate required fields
    
    View -> Service: evaluate_speaking(user_id,\nquestion_id, audio_file)
    activate Service
    
    Service -> DB: Query Question by question_id
    activate DB
    DB --> Service: Question object
    deactivate DB
    
    alt Question not found
        Service --> View: {error: "QUESTION_NOT_FOUND"}, 404
        View --> JS: JSON error response
        JS -> Student: Show error message
    else Question found
        Service -> Evaluator: validate_audio_file(audio_file)
        activate Evaluator
        
        Evaluator -> Evaluator: Check file extension\n(.wav, .mp3, .flac)
        Evaluator -> Evaluator: Check file size\n(<= 10MB)
        
        alt Invalid audio file
            Evaluator --> Service: (False, error_message)
            Service --> View: {error: "INVALID_INPUT"}, 400
            View --> JS: JSON error response
            JS -> Student: Show error message
        else Valid audio file
            Evaluator --> Service: (True, "OK")
            
            Service -> Evaluator: transcribe_audio(audio_file)
            
            Evaluator -> Whisper: POST audio.transcriptions.create\n{model: "whisper-1", file, language: "en"}
            activate Whisper
            note right of Whisper
                ASR: Audio-to-Text
                Using Whisper model
            end note
            
            Whisper -> Whisper: Transcribe speech\nDetect language
            Whisper --> Evaluator: {text, language, duration}
            deactivate Whisper
            
            alt No speech detected
                Evaluator --> Service: None
                Service --> View: {error: "NO_SPEECH_DETECTED"}, 400
                View --> JS: JSON error response
                JS -> Student: Show microphone error
            else Speech detected
                Evaluator -> Evaluator: Extract transcript text
                Evaluator --> Service: {transcript, language, duration}
                
                Service -> Evaluator: analyze_speaking(transcript,\nquestion, mode)
                
                Evaluator -> LLM: POST chat.completions.create\n{model, messages for speaking rubric}
                activate LLM
                note right of LLM
                    Prompt includes:
                    - TOEFL Speaking rubric
                    - Transcript text
                    - Evaluation criteria
                end note
                
                LLM -> LLM: Analyze speaking\nperformance
                LLM --> Evaluator: JSON response with\nscores and feedback
                deactivate LLM
                
                alt LLM fails
                    Evaluator --> Service: None
                    Service --> View: {error: "SERVICE_UNAVAILABLE"}, 503
                    View --> JS: JSON error response
                    JS -> Student: Show service unavailable
                else LLM success
                    Evaluator -> Evaluator: Parse JSON response
                    Evaluator --> Service: {overall_score, feedback, criteria}
                    
                    Service -> Storage: Save audio file\n(unique filename)
                    activate Storage
                    Storage --> Service: audio_path
                    deactivate Storage
                    
                    Service -> DB: Create Evaluation record\n(user_id, question, score,\ntranscript, audio_path)
                    activate DB
                    DB --> Service: Evaluation object
                    deactivate DB
                    
                    Service -> DB: Create DetailedScore records\n(Delivery, Fluency, Content)
                    activate DB
                    DB --> Service: DetailedScore objects
                    deactivate DB
                    
                    Service --> View: {status: "success",\nevaluation_id, score, feedback,\ntranscript, criteria}, 200
                    deactivate Evaluator
                    deactivate Service
                    
                    View --> JS: JSON success response
                    deactivate View
                    
                    JS -> JS: Calculate average score\nPrepare result data
                    JS -> Student: Display results popup with:\n- Score\n- Transcript\n- Feedback
                end
            end
        end
    end
end

deactivate JS

@enduml

@startuml Speaking_Activity_Diagram
title Speaking Evaluation - Activity Diagram (Team 7)

|Student|
start
:Click "Start Recording" button;

|JavaScript|
:Request microphone permission;

if (Permission granted?) then (no)
  :Show error:\n"Microphone access denied";
  stop
else (yes)
  :Initialize MediaRecorder;
  :Start recording audio;
  :Show recording timer;
  
  |Student|
  :Speak response;
  :Click "Stop Recording";
  
  |JavaScript|
  :Stop MediaRecorder;
  :Create audio blob;
  :Calculate duration;
  
  if (30s <= duration <= 90s?) then (no)
    :Show error:\n"Recording must be 30-90 seconds";
    stop
  else (yes)
    :Show submit confirmation;
    
    if (User confirms?) then (no)
      stop
    else (yes)
      :Show loading popup\n"درحال ارزیابی...";
      :Get user_id from AuthManager;
      :Create FormData with\naudio file;
      
      |Django View|
      :Receive POST request\n/api/submit-speaking/;
      :Parse form data;
      
      if (Required fields present?) then (no)
        :Return 400\nINVALID_INPUT;
        |JavaScript|
        :Close popup;
        :Show error alert;
        stop
      else (yes)
        |EvaluationService|
        :Query Question from DB;
        
        if (Question exists?) then (no)
          :Return 404\nQUESTION_NOT_FOUND;
          |JavaScript|
          :Close popup;
          :Show error alert;
          stop
        else (yes)
          |SpeakingEvaluator|
          :Check file extension;
          :Check file size;
          
          if (Valid audio file?) then (no)
            :Return validation error;
            |JavaScript|
            :Close popup;
            :Show error alert;
            stop
          else (yes)
            :Call Whisper API\naudio.transcriptions.create();
            
            if (Transcription successful?) then (no)
              :Return 400\nNO_SPEECH_DETECTED;
              |JavaScript|
              :Close popup;
              :Show microphone error;
              stop
            else (yes)
              :Extract transcript text;
              :Build speaking rubric prompt;
              :Call OpenAI LLM API;
              
              if (API call successful?) then (no)
                :Return 503\nSERVICE_UNAVAILABLE;
                |JavaScript|
                :Close popup;
                :Show error alert;
                stop
              else (yes)
                :Parse JSON response;
                :Save audio file to storage;
                
                |EvaluationService|
                :Create Evaluation record\nwith transcript;
                :Create DetailedScore records;
                :Return success response;
                
                |JavaScript|
                :Close loading popup;
                :Show result popup with:\n- Score\n- Transcript\n- Feedback;
                stop
              endif
            endif
          endif
        endif
      endif
    endif
  endif
endif

@enduml

@startuml History_Sequence_Diagram
title History/Analytics Retrieval - Sequence Diagram (Team 7)

actor Student
participant "Browser/\nJavaScript" as JS
participant "Django\nView\n(views.py)" as View
participant "Evaluation\nService" as Service
database "PostgreSQL\n(team7 DB)" as DB

Student -> JS: Navigate to\nHistory/Dashboard page
activate JS

JS -> JS: Initialize page
JS -> JS: Get user_id from\nAuthManager

JS -> View: GET /team7/api/history/?user_id={uuid}&limit=50
activate View

View -> View: Extract user_id\nfrom query params
View -> View: Validate user_id

View -> Service: get_user_history(user_id, limit)
activate Service

Service -> DB: Query Evaluation records\nWHERE user_id = ?\nORDER BY created_at DESC\nLIMIT ?
activate DB
note right of DB
    - Select related Question and Exam
    - Prefetch DetailedScore records
    - Filter by user_id
end note

DB --> Service: List of Evaluation objects
deactivate DB

alt No evaluations found
    Service --> View: {status: "no_data",\nmessage: "No attempts yet",\nattempts: []}, 200
    View --> JS: JSON response
    JS -> Student: Display "No history" message
else Evaluations found
    Service -> Service: Loop through evaluations
    
    loop For each evaluation
        Service -> Service: Build attempt object:\n- evaluation_id\n- task_type\n- exam info\n- scores\n- criteria
    end
    
    Service --> View: {status: "success",\ntotal_attempts, attempts: [...]}, 200
    deactivate Service
    
    View --> JS: JSON response with\nhistory data
    deactivate View
    
    JS -> JS: Parse history data
    JS -> JS: Render history table/cards
    JS -> JS: Generate charts\n(score trends, by type)
    
    JS -> Student: Display history with:\n- List of attempts\n- Score visualization\n- Performance trends
end

Student -> JS: Click on specific attempt

JS -> JS: Filter relevant data
JS -> Student: Show detailed popup with:\n- Feedback\n- Criteria scores\n- Timestamp

deactivate JS

@enduml

@startuml History_Activity_Diagram
title History/Analytics Retrieval - Activity Diagram (Team 7)

|Student|
start
:Navigate to History page;

|JavaScript|
:Initialize page;
:Get user_id from AuthManager;

if (User authenticated?) then (no)
  :Redirect to login;
  stop
else (yes)
  :Show loading spinner;
  
  |Django View|
  :Receive GET request\n/api/history/;
  :Extract user_id\nfrom query params;
  
  |EvaluationService|
  :Query database for\nEvaluation records;
  
  partition "Database Query" {
    :Filter by user_id;
    :Order by created_at DESC;
    :Limit to N records;
    :Join with Question table;
    :Join with Exam table;
    :Prefetch DetailedScore records;
  }
  
  if (Evaluations found?) then (no)
    :Return empty response\n{status: "no_data",\nattempts: []};
    
    |JavaScript|
    :Parse response;
    :Hide loading spinner;
    :Display message:\n"No attempts yet.\nStart a practice test!";
    stop
  else (yes)
    :Loop through evaluations;
    
    fork
      :Build Writing attempts list;
    fork again
      :Build Speaking attempts list;
    end fork
    
    :Combine all attempts;
    :Sort by timestamp;
    :Return JSON response\n{status: "success",\nattempts: [...]};
    
    |JavaScript|
    :Parse JSON response;
    :Hide loading spinner;
    
    fork
      :Render history table;
      :Display attempt cards;
    fork again
      :Calculate statistics;
      :Generate charts;
    fork again
      :Group by task type;
      :Calculate averages;
    end fork
    
    :Display complete history view;
    
    |Student|
    :Browse history;
    
    if (Click on attempt?) then (yes)
      |JavaScript|
      :Find attempt data\nby evaluation_id;
      :Build detailed view;
      :Show popup with:\n- Full feedback\n- Criteria breakdown\n- Scores\n- Timestamp;
      
      |Student|
      :Review detailed feedback;
    else (no)
      if (Apply filters?) then (yes)
        |JavaScript|
        :Filter by task type\nor date range;
        :Update display;
      endif
    endif
    
    stop
  endif
endif

@enduml

@startuml Overall_Architecture_Diagram
title Team 7 TOEFL Evaluation System - Architecture Overview

package "Frontend (Browser)" {
  [JavaScript/UI] as JS
  [AuthManager] as Auth
  [PopupManager] as Popup
  [MediaRecorder API] as Media
}

package "Django Backend" {
  package "Views Layer" {
    [submit_writing()] as WView
    [submit_speaking()] as SView
    [get_history()] as HView
    [get_analytics()] as AView
  }
  
  package "Service Layer" {
    [EvaluationService] as EvalService
    [WritingEvaluator] as WEval
    [SpeakingEvaluator] as SEval
    [AnalyticsService] as Analytics
  }
  
  package "Data Layer" {
    [Evaluation Model] as EvalModel
    [Question Model] as QModel
    [DetailedScore Model] as DSModel
    [Exam Model] as ExamModel
  }
}

package "External Services" {
  [OpenAI LLM API\n(gpt-4o-mini)] as LLM
  [OpenAI Whisper API\n(ASR)] as Whisper
}

database "PostgreSQL\n(team7 DB)" as DB
storage "File Storage" as FS

' Frontend connections
JS --> Auth : authenticate
JS --> Popup : show dialogs
JS --> Media : record audio
JS --> WView : POST /api/submit-writing/
JS --> SView : POST /api/submit-speaking/
JS --> HView : GET /api/history/
JS --> AView : GET /api/analytics/

' Views to Services
WView --> EvalService : evaluate_writing()
SView --> EvalService : evaluate_speaking()
HView --> EvalService : get_user_history()
AView --> Analytics : get_user_analytics()

' Services to Evaluators
EvalService --> WEval : validate_length()\nanalyze()
EvalService --> SEval : validate_audio_file()\ntranscribe_audio()\nanalyze_speaking()
EvalService --> Analytics : calculate statistics

' Evaluators to External APIs
WEval --> LLM : chat.completions.create()
SEval --> Whisper : audio.transcriptions.create()
SEval --> LLM : chat.completions.create()

' Services to Models
EvalService --> EvalModel : create evaluation
EvalService --> DSModel : create detailed scores
EvalService --> QModel : query questions
EvalService --> ExamModel : query exams
Analytics --> EvalModel : query history

' Models to Database
EvalModel --> DB : read/write
QModel --> DB : read
DSModel --> DB : write
ExamModel --> DB : read

' File storage
SEval --> FS : save audio file

note right of LLM
  - Writing analysis
  - Speaking scoring
  - Feedback generation
  - Rubric application
end note

note right of Whisper
  - Audio transcription
  - Speech-to-text
  - Language detection
end note

note bottom of DB
  Tables:
  - team7_evaluation
  - team7_question
  - team7_detailedscore
  - team7_exam
  - team7_apilog
end note

@enduml

@startuml Data_Model_Diagram
title Team 7 - Database Entity Relationship Diagram

entity "Exam" as exam {
  * exam_id : UUID <<PK>>
  --
  * title : VARCHAR(255)
  * exam_type : VARCHAR(20)
  total_time : INTEGER
  total_questions : INTEGER
  difficulty : INTEGER
}

entity "Question" as question {
  * question_id : UUID <<PK>>
  --
  title : VARCHAR(255)
  * prompt_text : TEXT
  * task_type : VARCHAR(20)
  * mode : VARCHAR(20)
  resource_url : VARCHAR(500)
  requirements : JSON
  tips : JSON
  exam_id : UUID <<FK>>
}

entity "Evaluation" as evaluation {
  * evaluation_id : UUID <<PK>>
  --
  * user_id : UUID
  * task_type : VARCHAR(20)
  submitted_text : TEXT
  audio_path : VARCHAR(500)
  overall_score : DECIMAL(3,1)
  ai_feedback : TEXT
  transcript_text : TEXT
  rubric_version_id : VARCHAR(50)
  * created_at : TIMESTAMP
  question_id : UUID <<FK>>
  exam_id : UUID <<FK>>
}

entity "DetailedScore" as detailedscore {
  * score_id : UUID <<PK>>
  --
  * criterion : VARCHAR(50)
  * score_value : DECIMAL(3,1)
  comment : TEXT
  evaluation_id : UUID <<FK>>
}

entity "APILog" as apilog {
  * log_id : UUID <<PK>>
  --
  user_id : UUID
  * endpoint : VARCHAR(200)
  * method : VARCHAR(10)
  * status_code : INTEGER
  * latency_ms : INTEGER
  * timestamp : TIMESTAMP
  error_message : TEXT
  request_size : INTEGER
  response_size : INTEGER
}

exam ||--o{ question : "contains"
question ||--o{ evaluation : "evaluated by"
exam ||--o{ evaluation : "belongs to"
evaluation ||--|{ detailedscore : "has detailed"

note right of evaluation
  - Stores both Writing and Speaking evaluations
  - Links to user via user_id (from core.User)
  - Tracks submission and AI analysis results
end note

note right of detailedscore
  Writing criteria:
  - Grammar
  - Vocabulary
  - Organization
  - Topic Development
  
  Speaking criteria:
  - Delivery
  - Fluency
  - Topic Development
end note

@enduml
